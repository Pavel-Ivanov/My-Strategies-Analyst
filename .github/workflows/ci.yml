name: CI / Quality and Tests

on:
  push:
    branches:
      - dev
      - main
  pull_request:
    branches:
      - dev
      - main

permissions:
  contents: write # –ù—É–∂–µ–Ω, –µ—Å–ª–∏ –≤—ã –∫–æ–≥–¥–∞-–ª–∏–±–æ –≤–∫–ª—é—á–∏—Ç–µ 'git-auto-commit-action'

jobs:
  # === 1. –ó–ê–î–ê–ù–ò–ï: –ü–†–û–í–ï–†–ö–ê –ö–ê–ß–ï–°–¢–í–ê –ö–û–î–ê (–õ–ò–ù–¢–ò–ù–ì) ===
  quality:
    runs-on: ubuntu-latest
    environment: Testing

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer:v2 # –î–æ–±–∞–≤–ª–µ–Ω–æ composer:v2 –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è

      # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è Composer –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer Dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Add Flux Credentials Loaded From ENV
        run: composer config http-basic.composer.fluxui.dev "${{ secrets.FLUX_USERNAME }}" "${{ secrets.FLUX_LICENSE_KEY }}"

      - name: Install PHP Dependencies (Lint Only)
        run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

      - name: Run Pint (Code Style Check)
        run: vendor/bin/pint

      # –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —á–∞—Å—Ç—å, –∫–∞–∫ –≤ –≤–∞—à–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª–µ, –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏
      # - name: Commit Changes
      #   uses: stefanzweifel/git-auto-commit-action@v5
      #   with:
      #     commit_message: fix code style
      #     commit_options: '--no-verify'
      #     file_pattern: |
      #       **/*
      #       !.github/workflows/*

      # ---

  # === 2. –ó–ê–î–ê–ù–ò–ï: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ö–û–î–ê ===
  ci:
    needs: [quality] # üëà –ó–ê–í–ò–°–ò–ú–û–°–¢–¨: –ó–∞–ø—É—Å—Ç–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ 'quality' –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ
    runs-on: ubuntu-latest
    environment: Testing

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. PHP/Composer Setup (–í–∫–ª—é—á–∞—è Xdebug)
      - name: Setup PHP 8.4 (with tools/coverage)
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          tools: composer:v2
          coverage: xdebug

      # 2. Node Setup (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º npm)
      - name: Setup Node 22 (with npm cache)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Install Node Dependencies
        run: npm ci # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'npm ci' –≤ CI/CD –¥–ª—è –±–æ–ª–µ–µ —á–∏—Å—Ç–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏

      # 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PHP –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–ü–æ–ª–Ω–∞—è, –¥–ª—è —Ç–µ—Å—Ç–æ–≤)
      - name: Add Flux Credentials Loaded From ENV
        run: composer config http-basic.composer.fluxui.dev "${{ secrets.FLUX_USERNAME }}" "${{ secrets.FLUX_LICENSE_KEY }}"

      # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ 'npm i' –≤ 'quality' —Ç—Ä–µ–±—É–µ—Ç, —á—Ç–æ–±—ã –∑–¥–µ—Å—å –±—ã–ª 'composer install'
      - name: Install PHP Dependencies (Full)
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      # 5. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ä–µ–¥—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤
      - name: Copy Environment File
        run: cp .env.example .env

      - name: Generate Application Key
        run: php artisan key:generate

      # 6. –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
      - name: Build Assets
        run: npm run build

      # 7. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      - name: Run Tests (Pest)
        run: ./vendor/bin/pest
